---
layout: page
title: "항공사 지수 개발 및 배치 추론 파이프라인 구축"
description: |
  2023\.11 ~ 2024\.03  
  항공사에서 활용할 지수를 개발하고, 일/월 배치 추론을 수행하는 파이프라인을 구축하였습니다.
hide_description: false
sitemap: false
---

0. Table of Contents
{:toc}


## Overview

A항공사는 여러 곳의 원천 데이터를 한 데 모아서 고객의 특성을 표현하는 CDP를 구축하고자 했고, 그 과정에서 로그 집계 기반 집계지수 및 머신러닝 모델 기반의 추론지수를 개발하고자 하였습니다. 해당 사업에서 저는 머신러닝 모델 기반의 추론지수 중 하나(High-Class 선호지수)를 Sagemaker Studio 환경에서 개발하였고, 모든 추론지수 개발이 완료된 후 지수들의 배치 추론 파이프라인을 Sagemaker, Glue, MWAA를 활용하여 구축하였습니다.

개발한 High-Class 선호지수는, 과거 데이터를 기반으로 향후 6개월 간 해당 고객이 프레스티지/퍼스트 클래스를 구매할지 여부를 예측하는 모델입니다. S3, Athena를 활용하여 기 구축된 Data Lake에서 EDA를 수행하였고, 성별/연령 및 마일리지 정보 등을 바탕으로 XGBoost를 활용한 예측 모델을 개발하였습니다.

추론지수 개발이 완료된 후, 5개 지수에 대해 각각의 배치 추론 파이프라인을 구성하였습니다. 스케줄러 및 파이프라인 코드는 MWAA(Airflow)를 활용하였고, MWAA가 지원하는 SagemakerOperator 및 GlueOperator를 활용하여 해당 서비스를 구동했습니다. Sagemaker Job 내에서 수행될 소스코드는 Python으로 개발하였으며, Load, Preprocess, Train, Inference, Postprocess의 5개 클래스로 구성하였습니다.


## Process

프로젝트에서 저는 크게 2가지의 업무를 수행하였습니다. 첫째로 High-Class 선호지수 개발, 둘째로 추론지수의 배치 추론 파이프라인 구축이었습니다.

### High-Class 선호지수 개발

#### 문제 정의

고객은 PR 클래스에 대한 프로모션을 통해 PR 클래스 구매율을 높이고 싶어했고, 그래서 PR, FR 클래스 등 상위 좌석에 대한 선호도가 높은 사람을 추출할 수 있는 기준을 만들고 싶어했습니다. 이에 따라, 저는 고객의 High-Class에 대한 선호를 표현하는 지수를 개발하게 되었습니다.

처음에는 단순히 PR 클래스에 대한 선호도를 보여주는 지수가 필요하다는 요구사항만 존재했기에, 객관적 기준이 불분명한 "선호"라는 개념을 데이터적인 문제로 정의할 필요가 있었습니다. 즉, 예측할 타겟 변수를 설정하는 과정이 필요했습니다. 

기존 논의에서는 과거에 "고객이 PR/FR 클래스 좌석을 탑승했는지 여부"를 타겟 변수로 설정하고, 고객의 과거 이력(탑승, 구매 등)을 설명변수로 설정하여 머신러닝 모델을 구축하는 논의가 있었습니다. 그러나 이렇게 문제를 정의한다면, 아래와 같은 문제가 발생한다고 보았습니다.

1. 설명변수에 타겟 변수와 깊게 관련있는 변수(탑승 관련 변수, 특히 PR/FR 탑승 이력)가 포함될 가능성이 크기에 데이터 누출이 생길 수 있습니다. 
2. 데이터 누출 오류를 해결하기 위해 위 변수를 설명변수에서 제거한다면, 고객의 High-Class 선호도와 가장 관련이 깊은 변수를 제거한다는 점에서 부적절합니다. 
3. 가까운 과거의 이력 데이터로, 그보다 더 이전에 발생한 "PR/FR 클래스 탑승"을 예측할 수도 있는 모델이 되어 버리기 때문에 부적절합니다.

위 문제를 해결하기 위해, 조금 복잡한 방식으로 문제 정의를 수정하였습니다.

- 설명 변수 : 고객의 과거 이력
- 타겟 변수 : 고객의 과거 PR/FR 클래스 탑승 여부 --> 고객의 향후 6개월 PR/FR 클래스 탑승 여부

이렇게 문제를 정의하면 타겟 변수가 고객의 과거 탑승 이력이 아니라 미래의 탑승 여부이기 때문에 데이터 누출에서 자유로우며, 설명변수와 타겟 변수의 시간 순서 또한 뒤바뀌지 않습니다. 물론 이러한 문제 정의 또한 단점이 있었습니다. 

먼저 모델 개발 시점을 2024년 1월로 가정할 경우, 고객의 과거 데이터는 2023년 12월까지 존재하기에 위와 같은 머신러닝 모델을 구축하려면 고객의 "~ 2023년 6월까지의 이력"을 바탕으로 "2023년 6월 ~ 12월의 PR/FR 탑승 여부"를 예측하는 모델을 개발해야 합니다. 이 경우, 개발된 모델이 과연 개발 시점인 "2024년 1월"에 운영할 수 있는 모델인지에 대한 고민이 있었습니다.

두 번째로 위와 같은 문제 정의는 고객에게 설명하기 어렵다는 단점이 있었습니다. 기존 논의였던, 과거 이력을 바탕으로 PR/FR 탑승 여부를 예측한다는 단순하고 쉬운 설명에 비하면, 위의 설명은 문제 상황에 대한 설명, 그리고 개발할 모델의 설명 변수와 타겟 변수에 대한 설명이 길게 포함되어야 하기에 설득에 대한 고민이 있었습니다.

결과적으로, 고객 및 LG CNS 팀원을 설득하고 후자의 방식으로 문제를 정의하여 모델을 개발하였습니다.


#### EDA

개발 시점에 활용할 수 있는 데이터를 활용하여 EDA를 수행하였습니다. 활용할 수 있는 데이터로는 고객의 예약/구매/탑승 이력, 마일리지 적립/사용 이력, 성별/연령 등 개인정보, 상용 여행 여부 등이 있었습니다. EDA를 통해 각종 변수들의 기초 통계 및 타겟 변수와의 연관성을 확인하고, 코로나 기간의 영향을 확인했습니다. 또한 타겟 변수 설정 시, 어느 정도 기간 동안의 PR/FR 탑승 여부를 타겟으로 삼을 것인가에 대한 기준을 결정하였습니다.

주로 수행했던 EDA 방식은 위에서 언급한 데이터가 PR/FR 탑승 여부와 얼마나 연관성이 있는지에 대한 통계 지표를 내는 것이었습니다. 다소 차이는 있었지만 대부분의 데이터가 타겟 변수와 연관이 있을 것으로 파악되었습니다. 특히 예약/탑승/구매 정보와 마일리지 적립 채널, 사용 채널은 큰 관련이 있었고 이를 바탕으로 설명변수를 구성하였습니다.

코로나 기간 동안의 데이터가 모델 학습에 악영향을 미칠 것인가에 대한 탐색 또한 수행하였습니다. 해당 기간 동안 고객 이력은 크게 감소하였으나, 1) 설명변수로 5년치 이력이라는 긴 시간의 데이터를 활용하였으며, 2) 모든 변수가 동일하게 감소하였습니다. 따라서 집계된 설명변수와 타겟 변수간의 연관성에 큰 영향을 미치지 않을 것이라 판단하고 해당 기간의 데이터까지 집계하도록 설명변수를 구성하였습니다.

사전 정의한 타겟 변수, 즉 특정 기간 동안의 PR/FR 탑승 여부에서 "특정 기간"을 어떻게 잡을 것인가에 대한 고민이 있었습니다. EDA를 통해 탑승 주기를 확인하고, 이를 바탕으로 고객과 협의하여 6개월이라는 기간을 잡았습니다.


#### 모델 개발

Sagemaker Studio 환경에서 모델을 개발하였습니다. XGBoost, LightGBM, RandomForest, LogisticRegression 의 4개 모델을 후보로 하여, 여러 개의 하이퍼파라미터 조합을 Bayesian Optimization을 활용하여 실험하였습니다. 실험 내역은 모두 기록하였습니다. 최종적으로, Validation Set에 대한 성능이 가장 높았던 LightGBM을 활용하여 최종 모델을 개발하였습니다.


### 배치 추론 파이프라인 구축

추론지수 개발작업이 완료된 후, 모든 개발된 추론지수에 대한 배치 추론 파이프라인을 구축하였습니다. 

#### 파이프라인 아키텍쳐

파이프라인은 아래와 같은 아키텍쳐로 구성하였습니다.

![image](/assets/img/myown/airline-batch-pipeline.png){:.lead loadings="lazy"}

파이프라인 내의 Sagemaker Job에서 실행되는 소스코드는 아래와 같은 구조로 개발하였습니다.

![image](/assets/img/myown/airline-batch-code-dev.png){:.lead loadings="lazy}

MWAA에 위의 구조로 총 4개의 스케줄을 신규 구성하였습니다. 2개의 지수는 일 배치로 매일 18시에 수행되도록 스케줄을 설정하였고, 2개의 지수는 월 배치로 매월 19시에 수행되도록 스케줄을 설정했습니다.


## Meaning

지수 개발 업무에서 아쉬웠던 점은, 문제 정의를 보다 쉽게 할 수 있는 방법이 더 없었을까에 대한 것이었습니다. 고객에게 해당 내용을 이해시키는 것이 어려워 고민이 많이 되었던 기억이 있습니다. 구축된 머신러닝 모델이 얼마나 엄밀하게 개발되었는가보다 중요한 것이 있겠다는 생각도 들었습니다.

파이프라인 구축에서 아쉬웠던 점은 개발이 아닌 운영 관점에서, 재학습/모니터링 파이프라인을 구축할 기회가 없었다는 점입니다. 모니터링을 위해 S3에 데이터 로그를 일자별로 남길 수 있도록 하였으나, 사람의 손길 없이 재학습하는 파이프라인은 사업 범위상, 시간상 구축하지 못하였습니다.


## Skills

Python, AWS(Sagemaker, S3, Athena, Glue, MWAA)

Go back to [Myeong Hyeon Son](/about/#projects){:.heading.flip-title}
{:.read-more}